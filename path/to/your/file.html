<html>
<head>
    <title>Your Page Title</title>
</head>
<body>
    <!-- Your existing body content -->
    
    <script>
// ============== UX PATCH: hide trajectories, hard stop drawing, apply override ==============  

(function () {
  function log(...args) { try { console.log('[UX-PATCH]', ...args); } catch(_){} }

  function insertHideTrajButton() {
    try {
      const btn = document.createElement('button');
      btn.className = 'header-btn btn-margin admin-only';
      btn.id = 'hideTrajBtn';
      btn.innerHTML = '<i class="fas fa-eye-slash"></i><span> –°–∫—Ä—ã—Ç—å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏</span>';
      btn.onclick = function () {
        if (typeof window.hideAllDrawnTrajectories === 'function') {
          window.hideAllDrawnTrajectories();
        } else {
          alert('–§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
        }
      };

      // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ —à–∞–ø–∫–µ –∏–ª–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
      const candidates = [
        document.querySelector('.header-controls'),
        document.querySelector('.admin-panel .panel-section'),
        document.querySelector('.admin-tab-content'),
        document.querySelector('.panel') // –æ–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å
      ];
      const host = candidates.find(Boolean);
      if (host) {
        host.appendChild(btn);
        log('–ö–Ω–æ–ø–∫–∞ "–°–∫—Ä—ã—Ç—å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏" –¥–æ–±–∞–≤–ª–µ–Ω–∞');
      } else {
        log('–ù–µ –Ω–∞—à—ë–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–∫–∏, –ø—Ä–æ–ø—É—Å–∫–∞—é –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ');
      }

      // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞ (–µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –µ—Å—Ç—å)
      if (typeof window.isAdmin !== 'undefined' && !window.isAdmin) {
        btn.style.display = 'none';
      }
    } catch (e) {
      console.error('[UX-PATCH] insertHideTrajButton error', e);
    }
  }

  function removeLayerIfExists(layer) {
    try {
      if (layer && window.map && typeof map.hasLayer === 'function' && map.hasLayer(layer)) {
        map.removeLayer(layer);
      }
    } catch (_) {}
  }

  function cleanupTargetOverlays(t) {
    try {
      // –ù–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–µ—Å—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–≤–µ—Ä–ª–µ–∏/–ª–∏–Ω–∏–∏
      const keys = [
        'trajectoryLine',
        'traveledTrajectory',
        'predictedTrajectoryLine',
        'completePredictedTrajectory',
        'predictionEndMarker',
        'historyLine',
        'futureLine'
      ];
      keys.forEach(k => {
        if (t && t[k]) {
          removeLayerIfExists(t[k]);
          t[k] = null;
        }
      });
    } catch (_) {}
  }

  // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: —Å–∫—Ä—ã—Ç—å –í–°–ï –ª–∏–Ω–∏–∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π (–Ω–µ –º–µ–Ω—è—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è)
  function hideAllDrawnTrajectories() {
    try {
      if (!Array.isArray(window.targets)) {
        console.warn('[UX-PATCH] targets –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }
      let hidden = 0;
      window.targets.forEach(t => {
        if (!t) return;
        if (t.trajectoryLine) {
          removeLayerIfExists(t.trajectoryLine);
          t.trajectoryLine = null;
          hidden++;
        }
      });
      console.log(`üîï –°–∫—Ä—ã—Ç–æ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π: ${hidden}`);
    } catch (e) {
      console.error('[UX-PATCH] hideAllDrawnTrajectories error', e);
    }
  }

  // –ñ—ë—Å—Ç–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è (—Å–Ω–∏–º–∞–µ—Ç –≤—Å–µ —Å–ª—É—à–∞—Ç–µ–ª–∏, —á–∏—Å—Ç–∏—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–∏–Ω–∏–∏/–º–∞—Å—Å–∏–≤—ã, UI)
  function hardStopDrawingMode() {
    try {
      console.log('üõë –ü–æ–ª–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è');

      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π/–∫—É—Ä—Å–æ—Ä
      if (window.map && map.dragging) map.dragging.enable();
      if (window.map && map.getContainer) {
        map.getContainer().style.cursor = '';
        map.getContainer().style.touchAction = '';
      }

      // –°–Ω–∏–º–∞–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –º—ã—à–∏/—Ç–∞—á–∞
      const evs = ['mousedown', 'mousemove', 'mouseup', 'click', 'touchstart', 'touchmove', 'touchend'];
      evs.forEach(ev => { try { if (window.map) map.off(ev); } catch(_) {} });

      // –í–æ–∑–º–æ–∂–Ω—ã–µ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π —Ä–∏—Å–æ–≤–∞–Ω–∏—è
      ['onDrawingStart','onDrawingMove','onDrawingEnd','onDrawingClick','handleDrawingClick','handleDrawingMove']
        .forEach(fn => {
          try {
            if (typeof window[fn] === 'function' && window.map) {
              map.off('click', window[fn]);
              map.off('mousemove', window[fn]);
              map.off('mousedown', window[fn]);
              map.off('touchstart', window[fn]);
              map.off('touchmove', window[fn]);
              map.off('touchend', window[fn]);
            }
          } catch(_) {}
        });

      // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–∏–Ω–∏–∏/–¥–∞–Ω–Ω—ã–µ
      if (window.drawingLine) { removeLayerIfExists(window.drawingLine); window.drawingLine = null; }
      if (window.tempDrawingLine) { removeLayerIfExists(window.tempDrawingLine); window.tempDrawingLine = null; }
      if (Array.isArray(window.drawingPoints)) window.drawingPoints.length = 0;
      if (Array.isArray(window.drawnTrajectory)) window.drawnTrajectory.length = 0;

      // –§—Ä–∏-–¥—Ä–æ—É –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
      window.__fdPainting = false;
      if (window.__fdLine) { removeLayerIfExists(window.__fdLine); window.__fdLine = null; }
      if (window.__drawMenu) { try { window.__drawMenu.remove(); } catch(_){} window.__drawMenu = null; }

      // –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏–µ–º
      try { if (typeof window.removeDrawingControls === 'function') window.removeDrawingControls(); } catch(_) {}

      console.log('üßπ –†–∏—Å–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–∫–ª—é—á–µ–Ω–æ');
    } catch (e) {
      console.error('[UX-PATCH] hardStopDrawingMode error', e);
    }
  }

  // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ applyDrawingToTarget: –Ω–æ–≤–∞—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—É—é
  function patchedApplyDrawingToTarget(targetId, points) {
    try {
      if (!Array.isArray(window.targets)) { alert('targets –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã'); return; }
      const target = window.targets.find(t => t && (t.id === targetId || String(t.id) === String(targetId)));
      if (!target) { alert('–¶–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return; }

      // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö —Ç–æ—á–µ–∫
      if (!Array.isArray(points) || points.length < 2) {
        alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–µ–∫ –¥–ª—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏');
        return;
      }
      // –ü—Ä–∏–≤–æ–¥–∏–º –∫ –º–∞—Å—Å–∏–≤—É [lat, lng]
      const traj = points.map(p => Array.isArray(p) ? [p[0], p[1]] : [p.lat, p.lng]);

      // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–≤–µ—Ä–ª–µ–∏/–ª–∏–Ω–∏–∏
      cleanupTargetOverlays(target);

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
      target.drawnTrajectory = traj;
      target.followingDrawnPath = true;
      target.currentTrajectoryPoint = 1;

      // –°–±—Ä–æ—Å –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏, –µ—Å–ª–∏ —Ç–∞–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      try {
        if (window.smoothAnimations && target.id in window.smoothAnimations) {
          delete window.smoothAnimations[target.id];
        }
      } catch(_) {}

      // –°–Ω–∞–ø –ø–æ–∑–∏—Ü–∏–∏ –∫ –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
      if (traj[0]) {
        target.latitude = traj[0][0];
        target.longitude = traj[0][1];
      }

      // –†–∏—Å—É–µ–º —Å–≤–µ–∂—É—é –ª–∏–Ω–∏—é —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
      try {
        if (window.L && window.map) {
          target.trajectoryLine = L.polyline(traj, {
            color: '#00FF00',
            weight: 3,
            opacity: 0.7
          }).addTo(map);
        }
      } catch (e) {
        console.warn('[UX-PATCH] –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å trajectoryLine', e);
      }

      alert(`–¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ —Ü–µ–ª–∏ ${target.name || target.id}!`);
    } catch (e) {
      console.error('[UX-PATCH] patchedApplyDrawingToTarget error', e);
    } finally {
      // –ü–æ–ª–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
      try { hardStopDrawingMode(); } catch(_) {}
    }
  }

  function install() {
    // 1) –ö–Ω–æ–ø–∫–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
    insertHideTrajButton();

    // 2) –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –≤ –≥–ª–æ–±–∞–ª
    window.hideAllDrawnTrajectories = hideAllDrawnTrajectories;

    // 3) –ó–∞–º–µ–Ω—è–µ–º stopDrawingMode –Ω–∞ –∂—ë—Å—Ç–∫—É—é –≤–µ—Ä—Å–∏—é
    window.__origStopDrawingMode = window.stopDrawingMode;
    window.stopDrawingMode = function () {
      try { hardStopDrawingMode(); } catch(e){ console.error(e); }
    };

    // 4) –ü–∞—Ç—á–∏–º applyDrawingToTarget (–Ω–µ –≤—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å)
    window.__origApplyDrawingToTarget = window.applyDrawingToTarget;
    window.applyDrawingToTarget = patchedApplyDrawingToTarget;

    // 5) –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ—Ä–∏-–¥—Ä–æ—É ‚Äî –ø–µ—Ä–µ–∞–¥—Ä–µ—Å—É–µ–º –≤ applyDrawingToTarget
    if (typeof window.__fdApply === 'function') {
      const origFdApply = window.__fdApply;
      window.__fdApply = function (targetId, points) {
        try {
          if (targetId != null && Array.isArray(points)) {
            return window.applyDrawingToTarget(targetId, points);
          }
          // –µ—Å–ª–∏ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ –∏–Ω–∞—è ‚Äî –ø—É—Å—Ç—å –æ—Ç—Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª
          return origFdApply.apply(this, arguments);
        } catch (e) {
          console.error('[UX-PATCH] __fdApply wrapper error', e);
          try { return origFdApply.apply(this, arguments); } catch(_) {}
        }
      };
    }

    log('–ü–∞—Ç—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', install, { once: true });
  } else {
    install();
  }
})();
    
    </script>
</body>
</html>